# GitHub Actions workflow for testing and continuous integration.
#
# This file performs testing using tox and tox.ini to define and configure the test environments.

name: CI

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -l {0}

jobs:
  # Github Actions supports ubuntu, windows, and macos virtual environments:
  # https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners
  ci_tests:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:

          - name: Python 3.8
            os: ubuntu-latest
            python: 3.8

          - name: Python 3.9
            os: ubuntu-latest
            python: 3.9

#          - name: Python 3.10
#            os: ubuntu-latest
#            python: 3.10

          - name: Python 3.8 (mac)
            os: macos-latest
            python: 3.8

          - name: Python 3.9 (mac)
            os: macos-latest
            python: 3.9

#          - name: Python 3.10 (mac)
#            os: macos-latest
#            python: 3.10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        environment-name: roman-data-workshop-env
        environment-file: 00_install/environment.yml
        cache-environment: true
        cache-downloads: true
        init-shell: bash
    - name: Set up environment
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: jwst_validation_notebooks
        environment-file: environment.yml
        create-args: >-
          python=${{ matrix.python }}
        cache-environment: true
        cache-downloads: true
        init-shell: bash
    - name: Test with nbpages
      run: |
        cd jwst_validation_notebooks
        python -m "nbpages.check_nbs"
